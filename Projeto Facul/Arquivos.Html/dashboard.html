<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FastWork</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Roboto', sans-serif;
        }
        
        .sidebar {
            background: #343a40;
            color: white;
            min-height: 100vh;
            position: fixed;
            width: 250px;
            padding: 20px 0;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .sidebar .nav-link {
            color: #adb5bd;
            padding: 10px 20px;
            border-radius: 0;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: #495057;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .stats-card {
            text-align: center;
            padding: 30px 20px;
        }
        
        .stats-card .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .api-test-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .user-info {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .api-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
                z-index: 1050;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="text-center mb-4">
            <h4><i class="bi bi-speedometer2"></i> Dashboard</h4>
        </div>
        
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#overview">
                    <i class="bi bi-house"></i> Vis√£o Geral
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#apis">
                    <i class="bi bi-cloud"></i> APIs
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#database">
                    <i class="bi bi-database"></i> Local Storage
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#users">
                    <i class="bi bi-people"></i> Usu√°rios
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="ts1.html">
                    <i class="bi bi-arrow-left"></i> Voltar ao Site
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="fazerLogout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- User Info -->
        <div class="user-info">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <img id="userAvatar" src="" alt="Avatar" class="rounded-circle" style="width: 80px; height: 80px;">
                </div>
                <div class="col-md-10">
                    <h3 id="userName">Carregando...</h3>
                    <p id="userType" class="mb-0">Tipo de usu√°rio</p>
                    <small id="lastLogin">√öltimo login: Carregando...</small>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="icon text-primary">
                        <i class="bi bi-people"></i>
                    </div>
                    <h5 id="totalUsers">0</h5>
                    <p class="text-muted">Total de Usu√°rios</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="icon text-success">
                        <i class="bi bi-person-check"></i>
                    </div>
                    <h5 id="activeUsers">0</h5>
                    <p class="text-muted">Usu√°rios Ativos</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="icon text-warning">
                        <i class="bi bi-building"></i>
                    </div>
                    <h5 id="totalCompanies">0</h5>
                    <p class="text-muted">Empresas</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="icon text-info">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <h5 id="totalJobs">10</h5>
                    <p class="text-muted">Vagas Dispon√≠veis</p>
                </div>
            </div>
        </div>

        <!-- API Testing Section -->
        <div class="api-test-section">
            <h4 class="mb-4"><i class="bi bi-cloud-check"></i> Teste de APIs</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>CEP API</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="cepInput" placeholder="Digite um CEP" value="01310-100">
                        <button class="btn btn-primary" onclick="testarAPIcep()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    <div id="cepResult" class="api-result" style="display: none;"></div>
                </div>
                
                <div class="col-md-6">
                    <h6>GitHub API</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="githubInput" placeholder="Username do GitHub" value="octocat">
                        <button class="btn btn-success" onclick="testarAPIgithub()">
                            <i class="bi bi-github"></i> Buscar
                        </button>
                    </div>
                    <div id="githubResult" class="api-result" style="display: none;"></div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>Cita√ß√µes Motivacionais</h6>
                    <button class="btn btn-warning w-100" onclick="testarAPicitacao()">
                        <i class="bi bi-chat-quote"></i> Obter Cita√ß√£o
                    </button>
                    <div id="quoteResult" class="api-result" style="display: none;"></div>
                </div>
                
                <div class="col-md-6">
                    <h6>Vagas de Emprego (Mock)</h6>
                    <button class="btn btn-info w-100" onclick="testarAPIvagas()">
                        <i class="bi bi-briefcase"></i> Carregar Vagas
                    </button>
                    <div id="jobsResult" class="api-result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Local Storage Info -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-database"></i> Informa√ß√µes do Local Storage</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Usu√°rios Cadastrados</h6>
                        <div id="usersList"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Sess√µes Ativas</h6>
                        <div id="sessionsList"></div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-outline-primary" onclick="exportarDados()">
                        <i class="bi bi-download"></i> Exportar Dados
                    </button>
                    <button class="btn btn-outline-secondary" onclick="atualizarDashboard()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                    <button class="btn btn-outline-danger" onclick="limparDados()">
                        <i class="bi bi-trash"></i> Limpar Dados
                    </button>
                </div>
            </div>
        </div>

        <!-- Gerenciamento de Sess√µes Remotas -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-devices"></i> Sess√µes Ativas em Outros Dispositivos</h5>
                <p class="text-muted">Gerencie suas sess√µes ativas em diferentes dispositivos</p>
                
                <div id="activeSessionsList"></div>
                
                <div class="mt-3">
                    <button class="btn btn-outline-warning" onclick="atualizarSessoesAtivas()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar Sess√µes
                    </button>
                    <button class="btn btn-outline-danger" onclick="encerrarTodasSessoes()">
                        <i class="bi bi-power"></i> Encerrar Todas as Outras Sess√µes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Sistema de APIs -->
    <script src="Arquivos.Js/APIs.js"></script>

    <script>
        // Verificar autentica√ß√£o ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard carregando...');
            setTimeout(() => {
                console.log('Verificando autentica√ß√£o...');
                if (typeof authSystem === 'undefined') {
                    console.error('Sistema de autentica√ß√£o n√£o encontrado');
                    alert('Sistema de autentica√ß√£o n√£o carregou. Redirecionando para login.');
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!authSystem.isAuthenticated()) {
                    console.log('Usu√°rio n√£o autenticado');
                    alert('Voc√™ precisa estar logado para acessar o dashboard');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('Usu√°rio autenticado, carregando dashboard...');
                carregarDadosUsuario();
                atualizarDashboard();
                atualizarSessoesAtivas();
            }, 1000);
        });

        // Carregar dados do usu√°rio
        function carregarDadosUsuario() {
            const user = authSystem.getCurrentUser();
            
            document.getElementById('userAvatar').src = user.avatar;
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userType').textContent = `${user.type.charAt(0).toUpperCase() + user.type.slice(1)} - ${user.email}`;
            
            if (user.lastLogin) {
                const lastLogin = new Date(user.lastLogin).toLocaleString('pt-BR');
                document.getElementById('lastLogin').textContent = `√öltimo login: ${lastLogin}`;
            } else {
                document.getElementById('lastLogin').textContent = 'Primeiro login';
            }
        }

        // Atualizar dashboard
        function atualizarDashboard() {
            const users = authSystem.db.getAllUsers();
            const sessions = JSON.parse(localStorage.getItem('fastwork_sessions') || '[]');
            
            // Estat√≠sticas
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = sessions.filter(s => s.expiresAt > Date.now()).length;
            document.getElementById('totalCompanies').textContent = users.filter(u => u.type === 'empresa').length;
            
            // Lista de usu√°rios
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = users.map(user => `
                <div class="d-flex align-items-center mb-2 p-2 bg-light rounded">
                    <img src="${user.avatar}" class="rounded-circle me-2" style="width: 30px; height: 30px;">
                    <div class="flex-grow-1">
                        <small><strong>${user.name}</strong></small><br>
                        <small class="text-muted">${user.type} - ${user.email}</small>
                    </div>
                </div>
            `).join('');
            
            // Lista de sess√µes
            const sessionsList = document.getElementById('sessionsList');
            const activeSessions = sessions.filter(s => s.expiresAt > Date.now());
            sessionsList.innerHTML = activeSessions.map(session => {
                const user = authSystem.db.getUserById(session.userId);
                const expires = new Date(session.expiresAt).toLocaleString('pt-BR');
                return `
                    <div class="mb-2 p-2 bg-light rounded">
                        <small><strong>${user ? user.name : 'Usu√°rio n√£o encontrado'}</strong></small><br>
                        <small class="text-muted">Expira em: ${expires}</small>
                    </div>
                `;
            }).join('') || '<p class="text-muted">Nenhuma sess√£o ativa</p>';
        }

        // Testar APIs
        async function testarAPIcep() {
            const cep = document.getElementById('cepInput').value;
            const resultDiv = document.getElementById('cepResult');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            const resultado = await apiService.buscarCEP(cep);
            
            if (resultado.success) {
                resultDiv.innerHTML = `
                    <strong>‚úÖ Sucesso!</strong><br>
                    <strong>CEP:</strong> ${resultado.data.cep}<br>
                    <strong>Endere√ßo:</strong> ${resultado.data.logradouro}<br>
                    <strong>Bairro:</strong> ${resultado.data.bairro}<br>
                    <strong>Cidade:</strong> ${resultado.data.localidade} - ${resultado.data.uf}
                `;
            } else {
                resultDiv.innerHTML = `<strong>‚ùå Erro:</strong> ${resultado.message}`;
            }
        }

        async function testarAPIgithub() {
            const username = document.getElementById('githubInput').value;
            const resultDiv = document.getElementById('githubResult');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            const resultado = await apiService.buscarUsuarioGitHub(username);
            
            if (resultado.success) {
                resultDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${resultado.data.avatar_url}" class="rounded-circle me-2" style="width: 50px; height: 50px;">
                        <div>
                            <strong>‚úÖ ${resultado.data.name || resultado.data.login}</strong><br>
                            <small>@${resultado.data.login}</small><br>
                            <small>Repos: ${resultado.data.public_repos} | Seguidores: ${resultado.data.followers}</small>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<strong>‚ùå Erro:</strong> ${resultado.message}`;
            }
        }

        async function testarAPicitacao() {
            const resultDiv = document.getElementById('quoteResult');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            const resultado = await apiService.obterCitacaoMotivacional();
            
            if (resultado.success) {
                resultDiv.innerHTML = `
                    <strong>‚úÖ Cita√ß√£o:</strong><br>
                    <em>"${resultado.data.content}"</em><br>
                    <small>- ${resultado.data.author}</small>
                `;
            } else {
                resultDiv.innerHTML = `<strong>‚ùå Erro:</strong> ${resultado.message}`;
            }
        }

        async function testarAPIvagas() {
            const resultDiv = document.getElementById('jobsResult');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            const resultado = await apiService.buscarVagas();
            
            if (resultado.success) {
                const vagas = resultado.data.slice(0, 3);
                resultDiv.innerHTML = `
                    <strong>‚úÖ ${resultado.data.length} vagas encontradas:</strong><br>
                    ${vagas.map(vaga => `
                        <div class="mt-2 p-2 border rounded">
                            <strong>${vaga.titulo}</strong><br>
                            <small>${vaga.empresa} - ${vaga.localizacao}</small><br>
                            <small>üí∞ ${vaga.salario}</small>
                        </div>
                    `).join('')}
                `;
            } else {
                resultDiv.innerHTML = `<strong>‚ùå Erro:</strong> ${resultado.message}`;
            }
        }

        // Gerenciar dados
        function exportarDados() {
            const dados = {
                usuarios: authSystem.db.getAllUsers(),
                sessoes: JSON.parse(localStorage.getItem('fastwork_sessions') || '[]'),
                exportadoEm: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `fastwork_dados_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function limparDados() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem('fastwork_users');
                localStorage.removeItem('fastwork_sessions');
                localStorage.removeItem('fastwork_session_token');
                
                alert('Dados limpos com sucesso! Voc√™ ser√° redirecionado para a p√°gina de login.');
                window.location.href = 'login.html';
            }
        }

        function fazerLogout() {
            if (confirm('Deseja fazer logout?')) {
                authSystem.logout();
            }
        }

        // Gerenciar sess√µes ativas
        function atualizarSessoesAtivas() {
            const sessoesList = document.getElementById('activeSessionsList');
            if (!authSystem.isAuthenticated()) {
                sessoesList.innerHTML = '<p class="text-muted">Fa√ßa login para ver suas sess√µes ativas</p>';
                return;
            }

            const sessoes = authSystem.getActiveSessions();
            
            if (sessoes.length === 0) {
                sessoesList.innerHTML = '<p class="text-muted">Nenhuma sess√£o ativa encontrada</p>';
                return;
            }

            let html = '<div class="row">';
            sessoes.forEach((sessao, index) => {
                const badgeClass = sessao.isCurrent ? 'bg-success' : 'bg-secondary';
                const badgeText = sessao.isCurrent ? 'Sess√£o Atual' : 'Remoto';
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 ${sessao.isCurrent ? 'border-success' : ''}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title">
                                        <i class="bi bi-${sessao.device.os === 'Windows' ? 'windows' : 
                                            sessao.device.os === 'Android' ? 'phone' : 
                                            sessao.device.os === 'iOS' ? 'phone' : 'laptop'}"></i>
                                        ${sessao.device.os}
                                    </h6>
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <strong>Navegador:</strong> ${sessao.device.browser}<br>
                                        <strong>Resolu√ß√£o:</strong> ${sessao.device.screen}<br>
                                        <strong>Login:</strong> ${sessao.createdAt}<br>
                                        <strong>√öltima Atividade:</strong> ${sessao.lastActivity}
                                        ${sessao.rememberDevice ? '<br><i class="bi bi-check-circle text-success"></i> Dispositivo Lembrado' : ''}
                                    </small>
                                </p>
                                ${!sessao.isCurrent ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="encerrarSessao('${sessao.token}')">
                                        <i class="bi bi-power"></i> Encerrar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            sessoesList.innerHTML = html;
        }

        function encerrarSessao(sessionToken) {
            if (confirm('Tem certeza que deseja encerrar esta sess√£o?')) {
                authSystem.terminateSession(sessionToken);
                atualizarSessoesAtivas();
                alert('Sess√£o encerrada com sucesso!');
            }
        }

        function encerrarTodasSessoes() {
            if (confirm('Tem certeza que deseja encerrar todas as outras sess√µes? Isso desconectar√° este usu√°rio de todos os outros dispositivos.')) {
                authSystem.terminateAllOtherSessions();
                atualizarSessoesAtivas();
                alert('Todas as outras sess√µes foram encerradas com sucesso!');
            }
        }
    </script>
</body>
</html>